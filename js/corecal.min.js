
var CORECAL=CORECAL||{calconfig:null,LocalStorage:{addValueToLocalStorage:function(a,b){if(this.storageAvailable("localStorage")){localStorage.setItem(a,b)}},storageAvailable:function(b){try{var d=window[b],a="__storage_test__";d.setItem(a,a);d.removeItem(a);return true}catch(c){return false}},getValueFromLocalStorage:function(a){var b="";if(this.storageAvailable("localStorage")){if(localStorage.key){return localStorage.getItem(a)}}return b},clearStorage:function(){if(this.storageAvailable("localStorage")){localStorage.clear()}}}};var CalendarConfig=function(){var b=Object.create(CalendarConfig.prototype);var a=new Date();b.options={theme:true,firstDay:1,defaultView:"agendaWeek",header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},date:a.getDate(),year:a.getFullYear(),month:a.getMonth(),slotMinutes:15,firstHour:a.getHours(),allDaySlot:false,selectable:false,selectHelper:false,lazyFetching:false,events:getEvents,select:handleEventSelection,eventClick:handleEventClick,eventResize:handleEventResize,eventDrop:handleEventDrop,viewDisplay:handleViewDisplay,eventRender:renderEvent};return b};CalendarConfig.prototype.setDateAndTime=function(a){if(typeof a==="undefined"){this.options.curr_date=new Date()}else{if(typeof a.getFullYear==="function"){this.options.year=a.getFullYear()}if(typeof a.getMonth==="function"){this.options.month=a.getMonth()}if(typeof a.getDate==="function"){this.options.date=a.getDate()}this.options.curr_hour=new Date().getHours()}};CalendarConfig.prototype.enable=function(){this.options.selectable={month:true,agendaWeek:true,agendaDay:true}};CalendarConfig.prototype.disable=function(){this.options.selectable=false};CalendarConfig.prototype.setView=function(a){this.options.defaultView=a};$(document).ready(function(){resetLocalStorage();$("#session_info_d").dialog({autoOpen:false,resizable:false,width:300,height:"auto",minHeight:0,modal:false,close:function(){module_handler.removeModule("CANCEL_SESSION");module_handler.removeModule("EDIT_NOTE");module_handler.removeModule("EDIT_USER");$("#session_info").empty()},});$("#signup_dialog").dialog({autoOpen:false,resizable:false,width:640,modal:true,show:{effect:"fade",duration:200},hide:{effect:"fade",duration:200},buttons:{Cancel:function(){$(this).dialog("close")},Register:function(){registerUser()}},close:function(a,b){resetRegistrationFormErrors();$("#registration_form")[0].reset()}});showCalendarView();setUpLoginPannel();loadServiceSelector();showCalendar();$("#corecal_login").button().click(function(){processLogIn();return false});$("#register_btn").click(function(){$("#signup_dialog").dialog("open");return false});$("#req_access_btn").button().click(function(){requestServiceAccess()});$(".login_txt_box").keypress(function(a){if(a.which==13){processLogIn();a.preventDefault()}});$("#corecal_logout").button().click(function(){processLogOut()});$("#facility_select").change(function(){$("#equipment_select option").remove();$("#service_select option").remove();$("#calendar").fullCalendar("removeEvents");resetRolePanel();getResourceList()});$("#equipment_select").change(function(){$("#service_select option").remove();getServiceList()});$("#service_select").change(function(){storePageConfig();getCalendarConfig()});$("body").fadeIn("fast")});function showCalendar(c){CORECAL.calconfig=new CalendarConfig();if(c===1){CORECAL.calconfig.enable()}else{CORECAL.calconfig.disable()}var b=CORECAL.LocalStorage.getValueFromLocalStorage("config_cal_view");if(b){CORECAL.calconfig.setView(b)}var a=CORECAL.LocalStorage.getValueFromLocalStorage("config_cal_date");if(a){CORECAL.calconfig.setDateAndTime(new Date(a))}$("#calendar").fullCalendar(CORECAL.calconfig.options)}function refreshCalendar(){$("#calendar").fullCalendar("refetchEvents")}function deleteEvent(a){$("#calendar").fullCalendar("removeEvents",a)}function updateEvent(a){}function getFacilityList(){$.ajax({url:"./ccny/scidiv/cores/ctrl/getFacilities.php",type:"POST",dataType:"json",success:function(a){if(a.hasOwnProperty("error")){if(a.error==1){notifyError(a.message)}else{$facilities=a.data;if($facilities.length>0){$("#facility_select").append($('<option value = ""></option>').html("Select one..."))}$.each($facilities,function(b,c){$("#facility_select").append($("<option value ="+c.id+"></option>").html(c.label))})}}else{notifyError("Error fetching data: Invalid reponse from the server.")}}})}function getFacilityStatistics(){var a=$("#facility_select option:selected");var b=a.val();$.ajax({url:"./php/getFacilityStats.php",type:"POST",dataType:"json",data:{facility_id:b},success:function(d){if(d.hasOwnProperty("error")){if(d.error==1){notifyError(d.message)}else{var c=d.data.usage;chart_options.series[0].data=c.values;chart_options.xAxis.categories=c.categories;if(chart!=null){chart.destroy()}chart=new Highcharts.Chart(chart_options)}}else{notifyError("Error fetching data: Invalid reponse from the server.")}}})}function getResourceList(){var a=$("#facility_select option:selected");var b=a.val();$.ajax({url:"./ccny/scidiv/cores/ctrl/getResources.php",type:"POST",dataType:"json",data:{facility_id:b},success:function(c){if(c.hasOwnProperty("error")){if(c.error==1){notifyError(c.message)}else{$resources=c.data;if($resources.length>0){$("#equipment_select").append($('<option value = ""></option>').html("Select one..."))}$.each($resources,function(d,e){$("#equipment_select").append($("<option value ="+e.id+"></option>").html(e.label))})}}else{notifyError("Error fetching data: Invalid reponse from the server.")}}})}function getServiceList(){var a=$("#equipment_select option:selected");var b=a.val();$.ajax({url:"./ccny/scidiv/cores/ctrl/getServices.php",type:"POST",dataType:"json",data:{rid:b},success:function(c){if(c.hasOwnProperty("error")){if(c.error==1){notifyError(c.message)}else{$services=c.data;$.each($services,function(d,e){$("#service_select").append($("<option value ="+e.id+"></option>").html(e.label))});$("#service_select").trigger("change")}}else{notifyError("Error fetching data: Invalid reponse from the server.")}}})}function renderEvent(b,a){a.attr("title",b.description)}function getEvents(e,a,d){var b=$("#equipment_select option:selected");var c=b.val();$.ajax({url:"./ccny/scidiv/cores/ctrl/getEvents.php",type:"POST",dataType:"json",data:{start:Math.round(e.getTime()/1000),end:Math.round(a.getTime()/1000),eq_id:c},success:function(g){if(g.hasOwnProperty("error")){if(g.error==1){notifyError(g.message)}else{var f=g.data;d(f)}}else{notifyError("Error fetching data: Invalid reponse from the server.")}}})}function handleEventSelection(c,a,b){$("#calendar").fullCalendar("unselect");createNewEvent(c,a,b)}function createNewEvent(b,d,e){var c=$("#service_select option:selected");var f=c.val();var a={};a.start=Math.round(b.getTime()/1000);a.end=Math.round(d.getTime()/1000);a.service=f;if(e){a.allday=1}else{a.allday=0}if(f==null){notifyError("Service type not selected.")}else{$.ajax({type:"POST",url:"./ccny/scidiv/cores/ctrl/newEvent.php",data:a,dataType:"json",cache:false,success:newEventCreatedHandler,error:newEventCreateErrorHandler})}}function newEventCreatedHandler(a){if(a.hasOwnProperty("error")){if(a.error==1){notifyError(a.message)}else{notifySuccess("Event added successfully")}}else{notifyError("Invalid reponse from the server. Operation failed")}$("#calendar").fullCalendar("refetchEvents")}function newEventCreateErrorHandler(a,c,b){notifyError(b)}function handleEventClick(d,b,a){var c={id:d.id,timestamp:d.timestamp};$.ajax({type:"POST",url:"./ccny/scidiv/cores/ctrl/getEventDetails.php",data:c,dataType:"html",cache:false,success:function(e){resetDialogContent();$("#session_info").append(e);showEventDetails(b)},error:function(){notifyError("Could not load event information.")}})}function reloadEventDetails(a){resetDialogContent();$.ajax({type:"POST",url:"./ccny/scidiv/cores/ctrl/getEventDetails.php",data:a,dataType:"html",cache:false,success:function(b){$("#session_info").append(b)},error:function(){notifyError("Could not load event information.")}})}function showEventDetails(b){var a=$("#session_info_d").dialog("option","width");var e=b.clientX-a/2;var c=b.clientY-20;var d=[e,c];$("#session_info_d").dialog("option","position",d);$("#session_info_d").dialog("open")}function resetDialogContent(){$("#session_info").empty()}function handleEventResize(e,c,b,d){var a={};a.record_id=e.id;a.dayDelta=c;a.minuteDelta=b;a.timestamp=e.timestamp;$.ajax({type:"POST",url:"./ccny/scidiv/cores/ctrl/resizeEvent.php",data:a,dataType:"json",cache:false,success:function(f){if(f.hasOwnProperty("error")){if(f.error==1){notifyError(f.message);d()}else{notifySuccess("Event resized.")}}else{notifyError("Invalid reponse from the server. Operation failed");d()}$("#calendar").fullCalendar("refetchEvents")},error:function(){notifyError("Error updating event information");d()}})}function handleEventDrop(e,c,b,f,d){var a={};a.record_id=e.id;a.timestamp=e.timestamp;a.dayDelta=c;a.minuteDelta=b;$.ajax({type:"POST",url:"./ccny/scidiv/cores/ctrl/moveEvent.php",data:a,dataType:"json",cache:false,success:function(g){if(g.hasOwnProperty("error")){if(g.error==1){notifyError(g.message);d()}else{notifySuccess("Event moved.")}}else{notifyError("Error: Invalid reponse from the server. Operation failed");d()}$("#calendar").fullCalendar("refetchEvents")},error:function(){notifyError("Error updating event information");d()}})}function handleViewDisplay(a){clearUI()}function clearUI(){if($("#session_info_d").dialog("isOpen")){$("#session_info_d").dialog("close")}}function showCalendarView(){clearUI();$("#calendar_view").show()}function setUpLoginPannel(){checkLogin()}function processLogIn(){var a={};a.user=$("#username_txt").val();a.pass=$("#password_txt").val();$.ajax({type:"POST",url:"./ccny/scidiv/cores/ctrl/loginProcessor.php",data:a,dataType:"json",cache:false,success:loginHandler,error:function(){notifyError("Error logging in. Please try again later")}})}function checkLogin(){$.ajax({type:"POST",url:"./ccny/scidiv/cores/ctrl/loginChecker.php",dataType:"json",cache:false,success:checkLoginHandler,error:function(){}})}function checkLoginHandler(d,b,c){var a=false;if(d.hasOwnProperty("error")){if(d.error==1){notifyError(d.message)}else{if(d.hasOwnProperty("data")){if(d.data!=null){a=true;$("#user_login").text(d.data.name);$("#user_last_log").text(d.data.last_active);$("#user_pi").text(d.data.pi);$("#user_type").text(d.data.type)}else{a=false}}else{a=false}}}else{notifyError("Error: Invalid reponse from the server. Operation failed");a=false}if(a){$("#log_in_panel").hide();$("#logged_in_panel").fadeIn("fast");$("#dashboard_role_panel").slideDown("fast")}else{$("#log_in_panel").fadeIn("fast");$("#logged_in_panel").hide();$("#dashboard_role_panel").hide()}}function loginHandler(c,a,b){if(c.hasOwnProperty("error")){if(c.error==1){notifyError(c.message);resetPassword()}else{$("#log_in_panel").hide();$("#logged_in_panel").fadeIn("fast");$("#dashboard_role_panel").slideDown("fast");$("#user_login").text(c.data.name);$("#user_last_log").text(c.data.last_active);$("#user_pi").text(c.data.pi);$("#user_type").text(c.data.type);getCalendarConfig();resetLogInPanel()}}else{notifyError("Error: Invalid reponse from the server. Operation failed")}}function processLogOut(){$.ajax({type:"POST",url:"./ccny/scidiv/cores/ctrl/logoutProcessor.php",dataType:"json",cache:false,success:function(a){if(a.hasOwnProperty("error")){if(a.error==1){notifyError(a.message)}else{$("#log_in_panel").fadeIn("fast");$("#logged_in_panel").hide();$("#dashboard_role_panel").hide();getCalendarConfig();clearUI();resetLogInPanel()}}else{notifyError("Error: Invalid reponse from the server. Operation failed")}},error:function(){notifyError("Error logging out. Please check your connection and try again")}})}function resetLogInPanel(){$("#username_txt").val("");resetPassword()}function resetPassword(){$("#password_txt").val("")}function getCalendarConfig(){resetUI();var b=$("#service_select option:selected");var c=b.val();var a={};a.serv_id=c;if(c!=null){$.ajax({type:"POST",url:"./ccny/scidiv/cores/ctrl/getCalendarConfig.php",data:a,dataType:"json",cache:false,success:function(f){if(f.hasOwnProperty("error")){if(f.error==1){setUserRole("N/A","black");resetCalendar(0)}else{var d=false;var e=false;var g="";if(f.data.hasOwnProperty("can_use")){d=Boolean(f.data.can_use)}if(f.data.hasOwnProperty("can_req")){e=Boolean(f.data.can_req)}if(f.data.hasOwnProperty("msg")){g=String(f.data.msg)}if(d){resetCalendar(1)}else{if(e){showRequestAccessButton()}resetCalendar(0)}if(g!=null){showText(g)}}}else{setUserRole("N/A","black");resetCalendar(0)}},error:function(){setUserRole("N/A","black");resetCalendar(0)}})}else{setUserRole("N/A","black");resetCalendar(0)}}function showRequestAccessButton(){$("#req_access_cont").show()}function resetUI(){resetRolePanel()}function resetRolePanel(){$("#user_role").text("");$("#role_txt_cont").hide();$("#req_access_cont").hide()}function getRecordID(){return $("#e_record_id").attr("rec_id")}function notifyError(a){var b=noty({text:a,type:"error",layout:"center",maxVisible:2,closeWith:["button"],timeout:2000,killer:true,animation:{open:{height:"toggle"},close:{height:"toggle"},easing:"swing",speed:200}})}function notifySuccess(a){var b=noty({text:a,type:"success",layout:"bottomRight",maxVisible:1,closeWith:["button"],killer:true,timeout:2000,animation:{open:{height:"toggle"},close:{height:"toggle"},easing:"swing",speed:200}})}function showConfirmMsg(a,b){var c=noty({text:b,type:"information",layout:"center",maxVisible:2,closeWith:["button"],killer:true,animation:{open:{height:"toggle"},close:{height:"toggle"},easing:"swing",speed:200}})}function showText(a){$("#role_txt_cont").show();$("#user_role").fadeOut().text(a).fadeIn("slow")}function setUserRole(b,a){$("#user_role").fadeOut().text(b).fadeIn("slow");$("#user_role").css("color",a)}function requestServiceAccess(){var b=$("#service_select option:selected");var a=b.val();$.ajax({type:"POST",url:"./ccny/scidiv/cores/ctrl/requestAccess.php",dataType:"json",data:{id:a},cache:false,success:function(c){if(c.hasOwnProperty("error")){if(c.error){notifyError(c.message)}else{getCalendarConfig();showConfirmMsg("Request submitted.","You will be notified by e-mail when your request is approved by facility administrator.")}}else{notifyError("Error: Invalid reponse from the server. Operation failed")}},error:function(){notifyError("Error requesting access. Please try again later")}})}function resetCalendar(c){var b=$("#calendar").fullCalendar("getDate");CORECAL.LocalStorage.addValueToLocalStorage("config_cal_date",b);var a=$("#calendar").fullCalendar("getView");CORECAL.LocalStorage.addValueToLocalStorage("config_cal_view",a.name);$("#calendar").fullCalendar("destroy");showCalendar(c)}function getSelectedResource(){return $("#sel_res_id").attr("rid")}function loadServiceSelector(){var a=getSelectedResource();if(typeof a==="string"){preloadServiceSelector(a)}else{getFacilityList()}}function preloadServiceSelector(a){$.ajax({url:"./ccny/scidiv/cores/ctrl/getServiceSelectorContent.php",type:"POST",dataType:"json",data:{rid:a},success:function(g){if(g.hasOwnProperty("error")){if(g.error==1){notifyError(g.message)}else{var c=null;var f=null;var e=null;var b=null;var h=null;if(g.hasOwnProperty("data")){if(g.data.hasOwnProperty("fac_array")){c=g.data.fac_array}if(g.data.hasOwnProperty("res_array")){f=g.data.res_array}if(g.data.hasOwnProperty("ser_array")){e=g.data.ser_array}if(g.data.hasOwnProperty("fac_id")){b=g.data.fac_id}if(g.data.hasOwnProperty("res_id")){h=g.data.res_id}var d="";if(c.length>0){$("#facility_select").append($('<option value = ""></option>').html("Select one..."))}$.each(c,function(i,j){d="";if(b!=null){if(j.id==b){d=" selected"}}$("#facility_select").append($("<option value ="+j.id+d+"></option>").html(j.label))});if(f.length>1){$("#equipment_select").append($('<option value = ""></option>').html("Select one..."))}$.each(f,function(i,j){d="";if(h!=null){if(j.id==h){d=" selected"}}$("#equipment_select").append($("<option value ="+j.id+d+"></option>").html(j.label))});$.each(e,function(i,j){$("#service_select").append($("<option value ="+j.id+"></option>").html(j.label))});$("#service_select").trigger("change")}else{getFacilityList()}}}else{notifyError("Error fetching data: Invalid reponse from the server.")}},error:function(){notifyError("Error loadnig data. Please try again later.")}})}function resetRegistrationFormErrors(){var a=$([]).add($("#uname")).add($("#psw1")).add($("#psw2")).add($("#fname")).add($("#lname")).add($("#phone")).add($("#email1")).add($("#email2")).add($("#pi_name")).add($("#pi_email")).add($("#pi_phone")).add($("#pi_address_1")).add($("#pi_address_2")).add($("#pi_city")).add($("#pi_state")).add($("#pi_zip"));a.removeClass("ui-state-error");$("#reg_error_msg").text("")}function registerUser(){var a={};a.uname=$("#uname").val();a.psw1=$("#psw1").val();a.psw2=$("#psw2").val();a.fname=$("#fname").val();a.lname=$("#lname").val();a.phone=$("#phone").val();a.email1=$("#email1").val();a.email2=$("#email2").val();a.pi_name=$("#pi_name").val();a.pi_email=$("#pi_email").val();a.pi_phone=$("#pi_phone").val();a.pi_address_1=$("#pi_address_1").val();a.pi_address_2=$("#pi_address_2").val();a.pi_city=$("#pi_city").val();a.pi_state=$("#pi_state").val();a.pi_zip=$("#pi_zip").val();resetRegistrationFormErrors();$.ajax({type:"POST",url:"./ccny/scidiv/cores/ctrl/register.php",dataType:"json",data:a,cache:false,success:function(f){if(f.hasOwnProperty("error")){if(f.error){if(f.hasOwnProperty("data")){var d=f.data;var c=d.field;var h=d.msg;var b=d.code;var g=d.type;switch(g){case 1:var e="#"+c;$(e).addClass("ui-state-error");$("#reg_error_msg").text(h);break;case 2:$("#reg_error_msg").text("Database error: "+h);break;default:$("#reg_error_msg").text("Unknown error")}}else{alert("Invalid reponse from the servers. No error info sent.")}}else{$("#signup_dialog").dialog("close");showConfirmMsg("Registration completed successfully.","Registration complete. You will be notified by e-mail when your account is approved by the system administrator.")}}else{alert("Error: Invalid reponse from the server. Operation failed")}},error:function(){alert("Error creating an account. Please try again later")}})}function storePageConfig(){}function resetLocalStorage(){CORECAL.LocalStorage.clearStorage()};